import React, { useState, useEffect } from 'react';
import { Card, CardContent } from "@/components/ui/card";
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from "@/components/ui/select";

const DIGIT_RANGES = [100, 500, 1000, 5000, 10000, 20000, 50000, 100000];

const fetchData = async () => {
    const response = await fetch('https://api.example.com/digits');
    const data = await response.json();
    return data;
};

const calculatePercentages = (digits, total) => {
    const counts = Array(10).fill(0);
    digits.forEach(d => counts[d]++);
    return counts.map(count => ((count / total) * 100).toFixed(2));
};

const calculateEvenOdd = (digits) => {
    const even = digits.filter(d => d % 2 === 0).length;
    const odd = digits.length - even;
    return { even: ((even / digits.length) * 100).toFixed(2), odd: ((odd / digits.length) * 100).toFixed(2) };
};

const calculateOverUnder = (digits) => {
    const results = {};
    for (let i = 0; i <= 8; i++) {
        const over = digits.filter(d => d > i).length;
        const under = digits.filter(d => d < i).length;
        results[i] = { over: ((over / digits.length) * 100).toFixed(2), under: ((under / digits.length) * 100).toFixed(2) };
    }
    return results;
};

const calculateRiseFall = (digits) => {
    let rise = 0, fall = 0;
    for (let i = 1; i < digits.length; i++) {
        if (digits[i] > digits[i - 1]) rise++;
        else if (digits[i] < digits[i - 1]) fall++;
    }
    return { rise: ((rise / (digits.length - 1)) * 100).toFixed(2), fall: ((fall / (digits.length - 1)) * 100).toFixed(2) };
};

const findMostLikelyDigit = (percentages) => {
    const maxPercentage = Math.max(...percentages);
    const digit = percentages.indexOf(maxPercentage);
    return { digit, confidence: maxPercentage.toFixed(2) };
};

export default function DigitTracker() {
    const [digits, setDigits] = useState([]);
    const [selectedRange, setSelectedRange] = useState(100);

    useEffect(() => {
        const interval = setInterval(async () => {
            const newDigits = await fetchData();
            setDigits(prev => [...prev, ...newDigits].slice(-100000));
        }, 1000);
        return () => clearInterval(interval);
    }, []);

    const displayedDigits = digits.slice(-selectedRange);
    const digitPercentages = calculatePercentages(displayedDigits, displayedDigits.length);
    const evenOdd = calculateEvenOdd(displayedDigits);
    const overUnder = calculateOverUnder(displayedDigits);
    const riseFall = calculateRiseFall(displayedDigits);
    const mostLikely = findMostLikelyDigit(digitPercentages);

    return (
        <div className="p-4 space-y-4">
            <h1 className="text-3xl font-bold text-center">Deriv Last Digit Tracker</h1>
            <div className="text-center text-xl">Last Digit: {digits[digits.length - 1]}</div>
            <Card className="p-4 bg-yellow-200">
                <CardContent className="text-center text-2xl font-bold">
                    Most Likely Digit: {mostLikely.digit} ({mostLikely.confidence}%)
                </CardContent>
            </Card>
            <div className="flex justify-center">
                <Select onValueChange={(value) => setSelectedRange(Number(value))}>
                    <SelectTrigger className="w-[200px]">
                        <SelectValue placeholder="Select digit range" />
                    </SelectTrigger>
                    <SelectContent>
                        {DIGIT_RANGES.map(range => (
                            <SelectItem key={range} value={range.toString()}>{range} digits</SelectItem>
                        ))}
                    </SelectContent>
                </Select>
            </div>
            <h2 className="text-2xl font-bold text-center mt-4">Percentages Breakdown</h2>
            <div className="grid grid-cols-2 gap-4">
                <Card className="bg-blue-200">
                    <CardContent className="text-center">Even: {evenOdd.even}% | Odd: {evenOdd.odd}%</CardContent>
                </Card>
                <Card className="bg-green-200">
                    <CardContent className="text-center">Rise: {riseFall.rise}% | Fall: {riseFall.fall}%</CardContent>
                </Card>
                {Object.entries(overUnder).map(([key, value]) => (
                    <Card key={key} className="bg-purple-200">
                        <CardContent className="text-center">Over {key}: {value.over}% | Under {key}: {value.under}%</CardContent>
                    </Card>
                ))}
            </div>
            <h2 className="text-2xl font-bold text-center mt-4">Digit Percentages</h2>
            <div className="grid grid-cols-5 gap-2">
                {digitPercentages.map((percent, digit) => (
                    <Card key={digit} className="bg-orange-200">
                        <CardContent className="text-center text-lg font-semibold">{digit}: {percent}%</CardContent>
                    </Card>
                ))}
            </div>
            <h2 className="text-2xl font-bold text-center mt-4">Last {selectedRange} Digits</h2>
            <div className="text-center text-lg font-mono break-words">{displayedDigits.join(' ')}</div>
            <h2 className="text-2xl font-bold text-center mt-4">Total Digits Collected: {digits.length}</h2>
        </div>
    );
}

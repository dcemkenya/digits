import React, { useState, useEffect } from 'react';
import { Card, CardContent } from "@/components/ui/card";
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from "@/components/ui/select";

const DIGIT_RANGES = [100, 500, 1000, 5000, 10000, 20000, 50000, 100000];

const fetchData = async () => {
    const response = await fetch('https://api.example.com/digits');
    const data = await response.json();
    return data;
};

const calculatePercentages = (digits, total) => {
    const counts = Array(10).fill(0);
    digits.forEach(d => counts[d]++);
    return counts.map(count => ((count / total) * 100).toFixed(2));
};

const calculateEvenOdd = (digits) => {
    const even = digits.filter(d => d % 2 === 0).length;
    const odd = digits.length - even;
    return { even: ((even / digits.length) * 100).toFixed(2), odd: ((odd / digits.length) * 100).toFixed(2) };
};

const calculateOverUnder = (digits) => {
    const results = {};
    for (let i = 0; i <= 8; i++) {
        const over = digits.filter(d => d > i).length;
        const under = digits.filter(d => d < i).length;
        results[i] = { over: ((over / digits.length) * 100).toFixed(2), under: ((under / digits.length) * 100).toFixed(2) };
    }
    return results;
};

const calculateRiseFall = (digits) => {
    let rise = 0, fall = 0;
    for (let i = 1; i < digits.length; i++) {
        if (digits[i] > digits[i - 1]) rise++;
        else if (digits[i] < digits[i - 1]) fall++;
    }
    return { rise: ((rise / (digits.length - 1)) * 100).toFixed(2), fall: ((fall / (digits.length - 1)) * 100).toFixed(2) };
};

const findMostLikelyDigit = (percentages) => {
    const maxPercentage = Math.max(...percentages);
    const digit = percentages.indexOf(maxPercentage);
    return { digit, confidence: maxPercentage.toFixed(2) };
};

export default function DigitTracker() {
    const [digits, setDigits] = useState([]);
    const [selectedRange, setSelectedRange] = useState(100);

    useEffect(() => {
        const interval = setInterval(async () => {
            const newDigits = await fetchData();
            setDigits(prev => [...prev, ...newDigits].slice(-100000));
        }, 1000);
        return () => clearInterval(interval);
    }, []);

    const displayedDigits = digits.slice(-selectedRange);
    const digitPercentages = calculatePercentages(displayedDigits, displayedDigits.length);
    const evenOdd = calculateEvenOdd(displayedDigits);
    const overUnder = calculateOverUnder(displayedDigits);
    const riseFall = calculateRiseFall(displayedDigits);
    const mostLikely = findMostLikelyDigit(digitPercentages);

    return (
        <div className="p-6 bg-gray-100 min-h-screen">
            <h1 className="text-3xl font-bold text-center mb-4">Deriv Last Digit Tracker</h1>
            <h2 className="text-xl text-center mb-2">Last Digit: <span className="font-semibold">{digits[digits.length - 1]}</span></h2>
            
            <Card className="p-4 mb-4">
                <CardContent>
                    <h3 className="text-2xl font-semibold text-center">Most Likely Digit</h3>
                    <p className="text-center text-lg mt-2">Most Likely Digit: <span className="font-bold text-green-600">{mostLikely.digit}</span> ({mostLikely.confidence}%)</p>
                </CardContent>
            </Card>

            <Select value={selectedRange} onValueChange={(value) => setSelectedRange(Number(value))}>
                <SelectTrigger className="w-full mb-4">
                    <SelectValue placeholder="Select digit range" />
                </SelectTrigger>
                <SelectContent>
                    {DIGIT_RANGES.map(range => (
                        <SelectItem key={range} value={range}>{range} digits</SelectItem>
                    ))}
                </SelectContent>
            </Select>

            <h3 className="text-2xl font-semibold text-center">Percentages Breakdown</h3>
            <div className="grid grid-cols-2 gap-4 text-lg mb-4">
                <p>Even: <span className="text-blue-500">{evenOdd.even}%</span> | Odd: <span className="text-blue-500">{evenOdd.odd}%</span></p>
                <p>Rise: <span className="text-red-500">{riseFall.rise}%</span> | Fall: <span className="text-red-500">{riseFall.fall}%</span></p>
                {Object.entries(overUnder).map(([key, value]) => (
                    <p key={key}>Over {key}: <span className="text-green-500">{value.over}%</span> | Under {key}: <span className="text-red-500">{value.under}%</span></p>
                ))}
            </div>

            <h3 className="text-2xl font-semibold text-center">Digit Percentages</h3>
            <div className="grid grid-cols-5 gap-2 text-center mb-4">
                {digitPercentages.map((percent, digit) => (
                    <div key={digit} className="p-2 bg-gray-200 rounded-lg">{digit}: <span className="font-semibold">{percent}%</span></div>
                ))}
            </div>

            <h3 className="text-2xl font-semibold text-center">Last {selectedRange} Digits</h3>
            <p className="text-center text-lg mb-4">{displayedDigits.join(' ')}</p>

            <h3 className="text-xl font-bold text-center">Total Digits Collected: {digits.length}</h3>
        </div>
    );
}

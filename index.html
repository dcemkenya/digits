import React, { useState, useEffect } from 'react';
import { Card, CardContent } from "@/components/ui/card";
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from "@/components/ui/select";

const DIGIT_RANGES = [100, 500, 1000, 5000, 10000, 20000, 50000, 100000];

const fetchData = async () => {
    const response = await fetch('https://api.example.com/digits');
    const data = await response.json();
    return data;
};

const calculatePercentages = (digits, total) => {
    const counts = Array(10).fill(0);
    digits.forEach(d => counts[d]++);
    return counts.map(count => ((count / total) * 100).toFixed(2));
};

const calculateEvenOdd = (digits) => {
    const even = digits.filter(d => d % 2 === 0).length;
    const odd = digits.length - even;
    return { even: ((even / digits.length) * 100).toFixed(2), odd: ((odd / digits.length) * 100).toFixed(2) };
};

const calculateOverUnder = (digits) => {
    const results = {};
    for (let i = 0; i <= 8; i++) {
        const over = digits.filter(d => d > i).length;
        const under = digits.filter(d => d < i).length;
        results[i] = { over: ((over / digits.length) * 100).toFixed(2), under: ((under / digits.length) * 100).toFixed(2) };
    }
    return results;
};

const calculateRiseFall = (digits) => {
    let rise = 0, fall = 0;
    for (let i = 1; i < digits.length; i++) {
        if (digits[i] > digits[i - 1]) rise++;
        else if (digits[i] < digits[i - 1]) fall++;
    }
    return { rise: ((rise / (digits.length - 1)) * 100).toFixed(2), fall: ((fall / (digits.length - 1)) * 100).toFixed(2) };
};

const findMostLikelyDigit = (percentages) => {
    const maxPercentage = Math.max(...percentages);
    const digit = percentages.indexOf(maxPercentage);
    return { digit, confidence: maxPercentage.toFixed(2) };
};

export default function DigitTracker() {
    const [digits, setDigits] = useState([]);
    const [selectedRange, setSelectedRange] = useState(100);

    useEffect(() => {
        const interval = setInterval(async () => {
            const newDigits = await fetchData();
            setDigits(prev => [...prev, ...newDigits].slice(-100000));
        }, 1000);
        return () => clearInterval(interval);
    }, []);

    const displayedDigits = digits.slice(-selectedRange);
    const digitPercentages = calculatePercentages(displayedDigits, displayedDigits.length);
    const evenOdd = calculateEvenOdd(displayedDigits);
    const overUnder = calculateOverUnder(displayedDigits);
    const riseFall = calculateRiseFall(displayedDigits);
    const mostLikely = findMostLikelyDigit(digitPercentages);

    return (
        <div className="p-4 bg-gray-100 min-h-screen">
            <h1 className="text-3xl font-bold text-center mb-4">Deriv Last Digit Tracker</h1>
            <h2 className="text-xl text-center mb-4">Last Digit: {digits[digits.length - 1]}</h2>
            <Card className="p-4 mb-4">
                <h3 className="text-center text-2xl font-semibold">Most Likely Digit</h3>
                <p className="text-center text-xl text-green-600 font-bold">{mostLikely.digit} ({mostLikely.confidence}%)</p>
            </Card>

            <div className="text-center mb-4">
                <Select value={selectedRange} onValueChange={setSelectedRange}>
                    <SelectTrigger>
                        <SelectValue placeholder="Select Range" />
                    </SelectTrigger>
                    <SelectContent>
                        {DIGIT_RANGES.map(range => (
                            <SelectItem key={range} value={range}>{`Last ${range} digits`}</SelectItem>
                        ))}
                    </SelectContent>
                </Select>
            </div>

            <h2 className="text-xl font-semibold text-center mb-2">Percentages Breakdown</h2>
            <div className="grid grid-cols-2 gap-4">
                <CardContent className="text-lg">
                    <p><strong>Even:</strong> {evenOdd.even}% | <strong>Odd:</strong> {evenOdd.odd}%</p>
                    <p><strong>Rise:</strong> {riseFall.rise}% | <strong>Fall:</strong> {riseFall.fall}%</p>
                    {Object.entries(overUnder).map(([key, value]) => (
                        <p key={key}><strong>Over {key}:</strong> {value.over}% | <strong>Under {key}:</strong> {value.under}%</p>
                    ))}
                </CardContent>

                <CardContent className="text-lg">
                    <h3 className="text-xl font-semibold mb-2">Digit Percentages</h3>
                    {digitPercentages.map((percent, digit) => (
                        <p key={digit}><strong>{digit}:</strong> {percent}%</p>
                    ))}
                </CardContent>
            </div>

            <h3 className="text-xl font-semibold text-center mt-4">Last {selectedRange} Digits</h3>
            <CardContent className="text-lg text-center font-mono">{displayedDigits.join(' ')}</CardContent>

            <h4 className="text-xl font-semibold text-center mt-4">Total Digits Collected: {digits.length}</h4>
        </div>
    );
}
